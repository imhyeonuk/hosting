<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
    <style>
        #map { height: 400px; }
    </style>
</head>
<body>
<button id="startDrawing">그림 그리기 시작</button>
<button id="stopDrawing" style="display:none;">그림 그리기 종료</button>
<button id="undoDrawing" style="display:none;">되돌리기</button>
<button id="clearDrawing" style="display:none;">초기화</button> <!-- 지우개 버튼 추가 -->
<button id="saveDrawing" style="display:none;">저장하기</button>
<a href="loadMap.html" id="viewSavedDrawing" style="display:none;"><button>저장한 그림 보러가기</button></a>
<input type="color" id="colorPicker"> <!-- 색상 선택기 추가 -->
<div id="map"></div>
<script>
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude,
            lon = position.coords.longitude;
        var mapOptions = {
            center: new naver.maps.LatLng(lat, lon),
            zoom: 17
        };
        var map = new naver.maps.Map('map', mapOptions);

        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat, lon),
            map: map,
            icon: {
                content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
                anchor: new naver.maps.Point(5, 5)
            }
        });

        var drawing = false;
        var path = [];
        var currentColor = '#5347AA'; // 초기 색상 설정
        var polyline = new naver.maps.Polyline({
            map: map,
            path: [],
            strokeColor: currentColor,
            strokeWeight: 3
        });

        function updatePolyline() {
            polyline.setMap(null); // 지도에서 폴리라인 제거
            polyline = new naver.maps.Polyline({
                map: map,
                path: path,
                strokeColor: currentColor, // 현재 선택된 색상 사용
                strokeWeight: 3
            });
        }

        // 그림 그리기 시작 전에만 색상 변경 가능
        document.getElementById('colorPicker').addEventListener('change', function() {
            if (!drawing) {
                currentColor = this.value;
                updatePolyline(); // 색상 변경 적용을 위해 폴리라인 업데이트
            }
        });

        document.getElementById('startDrawing').addEventListener('click', function() {
            drawing = true;
            this.style.display = 'none';
            document.getElementById('stopDrawing').style.display = 'inline';
            document.getElementById('undoDrawing').style.display = 'inline';
            document.getElementById('clearDrawing').style.display = 'inline'; // 그림 그리기 시작 시 지우개 버튼 표시
            document.getElementById('saveDrawing').style.display = 'none'; // 수정된 부분: 그림 그리기 시작 시 저장하기 버튼 숨김
            map.setCursor('crosshair');
            document.getElementById('colorPicker').disabled = true; // 색상 선택기 비활성화
            path = []; // 이전 경로 초기화
            updatePolyline(); // 폴리라인 업데이트 함수 호출
            naver.maps.Event.addListener(map, 'zoom_changed', updatePolyline);
        });

        document.getElementById('stopDrawing').addEventListener('click', function() {
            drawing = false;
            document.getElementById('startDrawing').style.display = 'inline';
            this.style.display = 'none';
            document.getElementById('undoDrawing').style.display = 'none';
            document.getElementById('clearDrawing').style.display = 'none'; // 그림 그리기 종료 시 지우개 버튼 숨김
            document.getElementById('saveDrawing').style.display = 'inline'; // 저장하기 버튼 표시
            document.getElementById('colorPicker').disabled = false; // 색상 선택기 활성화
            
            map.setCursor('');
            naver.maps.Event.removeListener(updatePolyline); // 확대/축소 이벤트 리스너 제거
            path = [];
            polyline.setPath(path);
        });


        

        document.getElementById('undoDrawing').addEventListener('click', function() {
            if (path.length > 0) {
                path.pop();
                polyline.setPath(path);
            }
        });

        // 초기화 버튼 클릭 시 그린 모든 것 제거
        document.getElementById('clearDrawing').addEventListener('click', function() {
            path = [];
            updatePolyline(); // 그린 그림을 바로 지우도록 호출
        });


         // 저장하기 버튼 클릭 이벤트 핸들러
    document.getElementById('saveDrawing').addEventListener('click', function() {
        const drawingData = {
            path: path,
            color: currentColor
        };
        localStorage.setItem('drawingData', JSON.stringify(drawingData)); // 로컬 저장소에 그림 데이터 저장
        alert('그림이 저장되었습니다.'); // 사용자에게 저장 완료 알림

        document.getElementById('viewSavedDrawing').style.display = 'inline';
    });
    // ...


        naver.maps.Event.addListener(map, 'click', function(e) {
            if (!drawing) return;
            console.log(`위도: ${e.coord.lat()}, 경도: ${e.coord.lng()}`);
            path.push(e.coord);
            polyline.setPath(path);
        });
    }, function(err) {
        console.warn(`ERROR(${err.code}): ${err.message}`);
    }, {
        maximumAge:60000,
        timeout:5000,
        enableHighAccuracy: true
    });
} else {
    alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
}
</script>
</body>
</html>
