<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cookie Walk Map Viewer</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
  <style>
    #map { height: 400px; }
    button { margin: 5px; }
  </style>
</head>
<body>
<div id="map"></div>
<button id="startWalking">그림 그리기 시작</button>
<button id="stopWalking" style="display:none;">그림 그리기 종료</button>

<script>
  var mapOptions = {
    center: new naver.maps.LatLng(37.3595704, 127.105399),
    zoom: 17
  };
  var map = new naver.maps.Map('map', mapOptions);
  var userMarker, walking = false, walkPath = [], savedPathPolyline;
  var tolerance = 10; // 회색선과의 최대 허용 거리 (미터)

  const savedDrawing = JSON.parse(localStorage.getItem('drawingData'));
  if (savedDrawing && savedDrawing.path.length > 0) {
    savedPathPolyline = new naver.maps.Polyline({
      map: map,
      path: savedDrawing.path,
      strokeColor: '#cccccc', // 회색
      strokeWeight: 3
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var userPos = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
        map.setCenter(userPos);
        updateUserMarker(userPos);
      }, function(err) {
        console.error(`ERROR(${err.code}): ${err.message}`);
      }, {
        maximumAge:60000,
        timeout:5000,
        enableHighAccuracy: true
      });

      document.getElementById('startWalking').addEventListener('click', function() {
        this.style.display = 'none';
        document.getElementById('stopWalking').style.display = 'inline';
        walking = true;
        startWalking();
      });

      document.getElementById('stopWalking').addEventListener('click', function() {
        this.style.display = 'none';
        document.getElementById('startWalking').style.display = 'inline';
        walking = false;
        stopWalking();
      });
    } else {
      alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
    }
  } else {
    alert('저장된 그림이 없습니다.');
  }

  function updateUserMarker(userPos) {
    if (userMarker) userMarker.setMap(null);
    userMarker = new naver.maps.Marker({
      position: userPos,
      map: map,
      icon: {
        content: `<div style="width:10px; height:10px; background-color:${savedDrawing.color}; border-radius:50%;"></div>`,
        anchor: new naver.maps.Point(5, 5)
      }
    });
  }

  function startWalking() {
    navigator.geolocation.watchPosition(function(position) {
      var userPos = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
      map.setCenter(userPos);
      updateUserMarker(userPos);
      if (isCloseToPath(userPos, savedPathPolyline, tolerance)) {
        walkPath.push(userPos);
        drawColorLine(walkPath, savedDrawing.color);
      }
    }, function(error) {
      console.error('Geolocation error:', error);
    }, {
      maximumAge: 10000,
      timeout: 5000,
      enableHighAccuracy: true
    });
  }

  function stopWalking() {
    if (navigator.geolocation) navigator.geolocation.clearWatch(updateUserMarker);
  }

  function isCloseToPath(userPos, pathPolyline, tolerance) {
    var path = pathPolyline.getPath();
    for (var i = 0; i < path.length; i++) {
      var distance = naver.maps.geometry.spherical.computeDistanceBetween(userPos, path[i]);
      if (distance < tolerance) {
        return true;
      }
    }
    return false;
  }

  function drawColorLine(path, color) {
    new naver.maps.Polyline({
      map: map,
      path: path,
      strokeColor: color,
      strokeWeight: 3,
      strokeOpacity: 0.7
    });
  }

</script>
</body>
</html>
