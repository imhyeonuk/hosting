<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>저장된 그림 불러오기</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
  <style>
    .map-container { margin-bottom: 40px; }
    .map { height: 400px; }
    .controls { text-align: center; margin-top: 8px; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <script>
    var savedMaps = JSON.parse(localStorage.getItem('savedMaps')) || [];

    function initializeMapContainer(mapData, index, position) {
      var container = document.createElement('div');
      container.className = 'map-container';
      document.body.appendChild(container);

      var mapDiv = document.createElement('div');
      mapDiv.id = 'map' + index;
      mapDiv.className = 'map';
      container.appendChild(mapDiv);

      var controlsDiv = document.createElement('div');
      controlsDiv.className = 'controls';
      container.appendChild(controlsDiv);

      var startWalkingBtn = document.createElement('button');
      startWalkingBtn.textContent = '걷기 시작';
      controlsDiv.appendChild(startWalkingBtn);

      var toggleDrawingBtn = document.createElement('button');
      toggleDrawingBtn.textContent = '도면 숨김';
      controlsDiv.appendChild(toggleDrawingBtn);

      var deleteMapBtn = document.createElement('button');
      deleteMapBtn.textContent = '지도 삭제';
      controlsDiv.appendChild(deleteMapBtn);

      var initialPosition = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
      
      var mapOptions = {
        center: initialPosition,
        zoom: 17
      };
      var map = new naver.maps.Map(mapDiv, mapOptions);

      var currentMarker = new naver.maps.Marker({
        position: initialPosition,
        map: map,
        icon: {
          content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
          anchor: new naver.maps.Point(5, 5)
        }
      });

      var basePath = JSON.parse(mapData.path).map(function(p) { return new naver.maps.LatLng(p.lat, p.lng); });
      var basePolyline = new naver.maps.Polyline({
        map: map,
        path: basePath,
        strokeColor: '#808080',
        strokeWeight: 3
      });

      var walking = false;
      var walkPath = [];
      var walkPolyline = new naver.maps.Polyline({
        map: null,
        strokeColor: mapData.color,
        strokeWeight: 3
      });

      function adjustPosition(actualPosition) {
        var minDistance = 10; // meters
        var closestPoint = null;
        var closestDistance = Infinity;
        basePath.forEach(function(point) {
          var distance = naver.maps.geometry.spherical.computeDistanceBetween(actualPosition, point);
          if (distance < closestDistance) {
            closestDistance = distance;
            closestPoint = point;
          }
        });
        return closestDistance <= minDistance ? closestPoint : actualPosition;
      }

      function handleWalking(position) {
        var actualPosition = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
        var adjustedPosition = adjustPosition(actualPosition);
        map.setCenter(adjustedPosition);
        currentMarker.setPosition(adjustedPosition);
        if (walking) {
          walkPath.push(adjustedPosition);
          walkPolyline.setPath(walkPath);
        }
      }

      startWalkingBtn.addEventListener('click', function() {
        walking = !walking;
        if (walking) {
          walkPolyline.setMap(map);
          this.textContent = '걷기 중지';
        } else {
          walkPolyline.setMap(null);
          walkPath = [];
          this.textContent = '걷기 시작';
        }
      });

      toggleDrawingBtn.addEventListener('click', function() {
        if (basePolyline.getMap()) {
          basePolyline.setMap(null);
          this.textContent = '도면 보기';
        } else {
          basePolyline.setMap(map);
          this.textContent = '도면 숨김';
        }
      });

      deleteMapBtn.addEventListener('click', function() {
        savedMaps.splice(index, 1);
        localStorage.setItem('savedMaps', JSON.stringify(savedMaps));
        container.remove();
      });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        savedMaps.forEach(function(mapData, index) {
          initializeMapContainer(mapData, index, position);
        });

        if (savedMaps.length === 0) {
          var noMapsText = document.createElement('p');
          noMapsText.textContent = '저장된 지도가 없습니다.';
          document.body.appendChild(noMapsText);
        }
      }, function(error) {
        console.error('Geolocation error: ' + error.message);
        alert("현재 위치를 가져올 수 없습니다.");
      });
    } else {
      alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
    }
  </script>
</body>
</html>
