<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>저장된 그림 불러오기</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
  <style>
    #map { height: 400px; }
  </style>
</head>
<body>
<div id="map"></div>
<button id="startWalking">걷기 시작</button>
<script>
  var map;
  var savedPathData = localStorage.getItem('savedPath');
  var savedPath = JSON.parse(savedPathData) || [];
  var savedColor = localStorage.getItem('savedColor') || '#000000';
  var polyline;
  var currentMarker = null;
  var walkPath = [];
  var walkPolyline;
  var walking = false;
  var positionWatchID = null;

  function updateCurrentLocationMarker(lat, lng) {
    if (currentMarker) {
      currentMarker.setPosition(new naver.maps.LatLng(lat, lng));
    } else {
      currentMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(lat, lng),
        map: map,
        icon: {
          content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
          anchor: new naver.maps.Point(5, 5)
        }
      });
    }
  }

  function startTrackingPath() {
    if (!walking) {
      walking = true;
      walkPolyline = new naver.maps.Polyline({
        map: map,
        path: walkPath,
        strokeColor: savedColor,
        strokeWeight: 3
      });
      positionWatchID = navigator.geolocation.watchPosition(function(position) {
        var newLat = position.coords.latitude;
        var newLng = position.coords.longitude;
        var newPosition = new naver.maps.LatLng(newLat, newLng);
        walkPath.push(newPosition);
        walkPolyline.setPath(walkPath);
        updateCurrentLocationMarker(newLat, newLng);
      }, function(err) {
        console.error(`ERROR(${err.code}): ${err.message}`);
      }, {
        maximumAge: 10000,
        timeout: 5000,
        enableHighAccuracy: true
      });
      document.getElementById('startWalking').textContent = "걷기 중지";
    } else {
      stopTrackingPath();
    }
  }

  function stopTrackingPath() {
    if (walking) {
      walking = false;
      navigator.geolocation.clearWatch(positionWatchID);
      document.getElementById('startWalking').textContent = "걷기 시작";
    }
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var lat = position.coords.latitude,
          lng = position.coords.longitude;
      var mapOptions = {
        center: new naver.maps.LatLng(lat, lng),
        zoom: 17
      };
      map = new naver.maps.Map('map', mapOptions);
      updateCurrentLocationMarker(lat, lng);

      polyline = new naver.maps.Polyline({
        map: map,
        path: savedPath.map(function(p) { return new naver.maps.LatLng(p.lat, p.lng); }),
        strokeColor: '#808080',
        strokeWeight: 3
      });

      document.getElementById('startWalking').addEventListener('click', startTrackingPath);
    }, function(err) {
      console.error(`ERROR(${err.code}): ${err.message}`);
      alert("위치 정보를 가져올 수 없습니다. 위치 서비스 설정을 확인해주세요.");
    }, {
      maximumAge: 60000,
      timeout: 5000,
      enableHighAccuracy: true
    });
  } else {
    alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
  }
</script>
</body>
</html>
