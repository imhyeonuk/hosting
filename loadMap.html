<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
</head>
<body>
<button id="startDrawingPath">시작하기</button>
<div id="map" style="height: 400px;"></div>
<script>
  var mapOptions = {
    center: new naver.maps.LatLng(37.3595704, 127.105399),
    zoom: 17
  };
  var map = new naver.maps.Map('map', mapOptions);

// 사용자 위치 마커 초기화
var userMarker = new naver.maps.Marker({
        map: map,
        icon: {
            content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
            anchor: new naver.maps.Point(5, 5)
        }
    });







  // 사용자 위치 표시
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var userLat = position.coords.latitude,
          userLon = position.coords.longitude;
      var userMarker = new naver.maps.Marker({
        position: new naver.maps.LatLng(userLat, userLon),
        map: map,
        icon: {
          content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
          anchor: new naver.maps.Point(5, 5)
        }
      });

      // 지도의 중심을 사용자 위치로 설정
      map.setCenter(new naver.maps.LatLng(userLat, userLon));

    }, function(err) {
      console.error(`ERROR(${err.code}): ${err.message}`);
    }, {
      maximumAge:60000,
      timeout:5000,
      enableHighAccuracy: true
    });
  } else {
    alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
  }

// 저장된 그림 데이터 불러오기
const savedDrawing = JSON.parse(localStorage.getItem('drawingData'));
    if (savedDrawing && savedDrawing.path.length > 0) {
        // 옅은 회색으로 경로 그리기
        var polyline = new naver.maps.Polyline({
            map: map,
            path: savedDrawing.path,
            strokeColor: '#cccccc', // 옅은 회색
            strokeWeight: 3
        });

        console.log(savedDrawing.color);
    

    // 지도 중심을 폴리라인의 첫 번째 점으로 설정
    map.setCenter(polyline.getPath().getAt(0));
  } else {
    alert('저장된 그림이 없습니다.');
  }

   // 사용자 위치 추적
   function trackUserPosition() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(function(position) {
                var userLat = position.coords.latitude;
                var userLon = position.coords.longitude;

                // 사용자 위치로 마커 업데이트
                var newPosition = new naver.maps.LatLng(userLat, userLon);
                userMarker.setPosition(newPosition);

                // 사용자 위치로 지도 중심 이동 (선택 사항)
                map.setCenter(newPosition);

            }, function(err) {
                console.error(`ERROR(${err.code}): ${err.message}`);
            }, {
                enableHighAccuracy: true, // 더 정확한 위치 정보를 위해
                maximumAge: 0,
                timeout: 27000
            });
        } else {
            alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
        }
    }

    trackUserPosition();




    document.getElementById('startDrawingPath').addEventListener('click', function() {
    // 시작하기 버튼 클릭 이벤트 핸들러
    trackUserPositionAndUpdatePathColor();
});

function trackUserPositionAndUpdatePathColor() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(function(position) {
            const userPosition = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

            // 저장된 경로와 현재 위치를 비교하고, 가까운 선분의 색상을 변경
            const isNearPath = checkIfNearPath(userPosition, savedDrawing.path);
            if (isNearPath) {
                // 폴리라인 색상을 변경
                polyline.setStrokeColor(savedDrawing.color); // 사용자가 선택한 색상으로 변경
            }
        }, function(error) {
            console.error(`ERROR(${error.code}): ${error.message}`);
        }, {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000
        });
    } else {
        alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
    }
}

function checkIfNearPath(userPosition, path) {
    // 사용자 위치와 경로의 각 점 사이의 거리를 계산하여, 특정 거리 이내에 있는지 확인
    // 이 함수는 사용자 위치와 경로의 점들 사이의 거리를 계산하고,
    // 사용자가 경로에 가까이 있을 때 true를 반환해야 합니다.
    return path.some(point => {
        const pathPoint = new naver.maps.LatLng(point[0], point[1]);
        return naver.maps.geometry.spherical.computeDistanceBetween(userPosition, pathPoint) < 30; // 30미터 이내로 설정
    });
}














    
</script>
</body>
</html>
